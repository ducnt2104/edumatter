<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduChem Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  </head>
  <body class="bg-gray-100 font-sans h-screen overflow-hidden">
    <div
      id="status-bar"
      class="bg-red-500 text-white text-xs text-center py-1 hidden"
    >
      M·∫•t k·∫øt n·ªëi v·ªõi Server! H√£y ki·ªÉm tra l·∫°i terminal node server.js
    </div>

    <div
      id="screen-login"
      class="flex h-full items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600"
    >
      <div class="bg-white p-8 rounded-xl shadow-2xl w-96">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">
          EduChem
        </h1>
        <input
          type="text"
          id="username"
          class="w-full border p-3 rounded mb-4"
          placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."
        />
        <button
          onclick="login()"
          class="w-full bg-indigo-600 text-white font-bold py-3 rounded hover:bg-indigo-700"
        >
          V√ÄO CHAT
        </button>
      </div>
    </div>

    <div id="screen-lobby" class="hidden h-full flex flex-col">
      <div class="bg-white shadow p-4 flex justify-between items-center">
        <h2 class="font-bold text-xl">Danh S√°ch Ph√≤ng</h2>
        <div>
          <span id="display-name" class="mr-4 font-bold"></span>
          <button
            onclick="toggleModal(true)"
            class="bg-green-600 text-white px-4 py-2 rounded"
          >
            + T·∫°o Ph√≤ng
          </button>
        </div>
      </div>
      <div
        id="room-list"
        class="flex-1 p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-3 gap-6"
      >
        <p
          class="text-center w-full col-span-3 text-gray-500 mt-10"
          id="loading-text"
        >
          <i class="fa-solid fa-spinner fa-spin"></i> ƒêang k·∫øt n·ªëi t·ªõi m√°y
          ch·ªß...
        </p>
      </div>
    </div>

    <div id="screen-chat" class="hidden h-full flex flex-col bg-white">
      <div
        class="bg-indigo-600 p-4 text-white flex justify-between items-center"
      >
        <button onclick="leaveRoom()" class="bg-indigo-500 px-3 py-1 rounded">
          Wait, Quay l·∫°i
        </button>
        <h3 id="current-room-name" class="font-bold">Ph√≤ng Chat</h3>
        <div class="w-10"></div>
      </div>
      <div
        id="msg-container"
        class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"
      ></div>

      <div class="p-4 bg-white border-t">
        <div id="file-preview" class="hidden text-sm text-blue-600 mb-2">
          ƒêang ch·ªçn file: <span id="preview-name" class="font-bold"></span>
          <button onclick="clearFile()" class="text-red-500 ml-2 font-bold">
            X
          </button>
        </div>
        <form onsubmit="sendMessage(event)" class="flex gap-2">
          <label
            class="cursor-pointer p-3 bg-gray-200 rounded hover:bg-gray-300"
          >
            <i class="fa-solid fa-paperclip"></i>
            <input
              type="file"
              id="file-input"
              class="hidden"
              onchange="handleFileSelect(this)"
            />
          </label>
          <input
            id="msg-input"
            type="text"
            class="flex-1 border rounded-full px-4"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
          />
          <button
            type="submit"
            class="bg-indigo-600 text-white px-6 rounded-full"
          >
            G·ª≠i
          </button>
        </form>
      </div>
    </div>

    <div
      id="modal-create"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded w-80">
        <h3 class="font-bold mb-4">T·∫°o Ph√≤ng M·ªõi</h3>
        <input
          id="new-room-name"
          class="w-full border p-2 mb-2 rounded"
          placeholder="T√™n ph√≤ng"
        />
        <input
          id="new-room-pass"
          class="w-full border p-2 mb-4 rounded"
          placeholder="M·∫≠t kh·∫©u (t√πy ch·ªçn)"
        />
        <div class="flex justify-end gap-2">
          <button
            onclick="toggleModal(false)"
            class="bg-gray-300 px-3 py-1 rounded"
          >
            H·ªßy
          </button>
          <button
            onclick="createRoom()"
            class="bg-indigo-600 text-white px-3 py-1 rounded"
          >
            T·∫°o
          </button>
        </div>
      </div>
    </div>

    <script>
      // FIX 2: K·∫æT N·ªêI TR·ª∞C TI·∫æP V√ÄO C·ªîNG 3000
      const socket = io("http://localhost:3000", {
        transports: ["websocket", "polling"], // B·∫Øt bu·ªôc d√πng giao th·ª©c chu·∫©n
      });

      let myName = "";
      let currentRoomId = "";
      let selectedFile = null;

      // --- KI·ªÇM TRA K·∫æT N·ªêI ---
      socket.on("connect", () => {
        console.log("‚úÖ ƒê√£ k·∫øt n·ªëi Socket th√†nh c√¥ng!");
        document.getElementById("status-bar").classList.add("hidden");
        // N·∫øu ƒëang ·ªü m√†n h√¨nh lobby th√¨ x√≥a ch·ªØ loading
        const loading = document.getElementById("loading-text");
        if (loading) loading.innerText = "Ch∆∞a c√≥ ph√≤ng n√†o. H√£y t·∫°o m·ªõi!";
      });

      socket.on("connect_error", (err) => {
        console.error("‚ùå L·ªói k·∫øt n·ªëi:", err);
        document.getElementById("status-bar").innerText =
          "‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi Server! Ki·ªÉm tra xem ƒë√£ ch·∫°y 'node server.js' ch∆∞a?";
        document.getElementById("status-bar").classList.remove("hidden");
      });

      // --- LOGIC CH√çNH ---
      function login() {
        const name = document.getElementById("username").value.trim();
        if (!name) return alert("Nh·∫≠p t√™n ƒëi b·∫°n ∆°i!");
        myName = name;
        document.getElementById("display-name").innerText = name;
        document.getElementById("screen-login").classList.add("hidden");
        document.getElementById("screen-lobby").classList.remove("hidden");

        // üí° B∆Ø·ªöC S·ª¨A: G·ª¨I Y√äU C·∫¶U L·∫§Y DANH S√ÅCH PH√íNG
        socket.emit("get_initial_rooms");
      }

      function toggleModal(show) {
        document
          .getElementById("modal-create")
          .classList.toggle("hidden", !show);
      }

      // --- X·ª¨ L√ù PH√íNG ---
      socket.on("update_rooms", (rooms) => {
        console.log("-> Nh·∫≠n danh s√°ch ph√≤ng:", rooms); // Debug xem c√≥ nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu kh√¥ng
        const list = document.getElementById("room-list");
        list.innerHTML = "";

        if (rooms.length === 0) {
          list.innerHTML = `<p class="text-center w-full col-span-3 text-gray-500">Hi·ªán ch∆∞a c√≥ ph√≤ng n√†o.</p>`;
          return;
        }

        rooms.forEach((room) => {
          const div = document.createElement("div");
          div.className =
            "bg-white p-4 rounded border hover:shadow-lg cursor-pointer";
          div.onclick = () => joinRoomRequest(room.id, room.isPrivate);
          div.innerHTML = `
                    <div class="font-bold text-indigo-700 text-lg">${
                      room.name
                    }</div>
                    <div class="text-sm text-gray-500 mt-1">
                        ${
                          room.isPrivate ? "üîí C√≥ m·∫≠t kh·∫©u" : "üîì C√¥ng khai"
                        } | üë§ ${room.count} ng∆∞·ªùi
                    </div>
                `;
          list.appendChild(div);
        });
      });

      function createRoom() {
        const name = document.getElementById("new-room-name").value;
        const pass = document.getElementById("new-room-pass").value;
        if (!name) return alert("Ch∆∞a nh·∫≠p t√™n ph√≤ng!");

        socket.emit("create_room", { name, password: pass, owner: myName });
        toggleModal(false);
        // Reset √¥ nh·∫≠p
        document.getElementById("new-room-name").value = "";
        document.getElementById("new-room-pass").value = "";
      }

      function joinRoomRequest(roomId, isPrivate) {
        let password = "";
        if (isPrivate) {
          password = prompt("Nh·∫≠p m·∫≠t kh·∫©u ph√≤ng:");
          if (password === null) return;
        }
        socket.emit("join_room", { roomId, password, username: myName });
      }

      // --- X·ª¨ L√ù TRONG PH√íNG ---
      socket.on("join_success", (data) => {
        currentRoomId = data.roomId;
        document.getElementById("current-room-name").innerText = data.roomName;
        document.getElementById("screen-lobby").classList.add("hidden");
        document.getElementById("screen-chat").classList.remove("hidden");
        document.getElementById("msg-container").innerHTML = "";
        data.history.forEach(renderMessage);
      });

      socket.on("error_msg", (msg) => alert(msg));

      function leaveRoom() {
        socket.emit("leave_room", { roomId: currentRoomId, username: myName });
        document.getElementById("screen-chat").classList.add("hidden");
        document.getElementById("screen-lobby").classList.remove("hidden");
        currentRoomId = "";
      }

      // --- CHAT & FILE ---
      function handleFileSelect(input) {
        if (input.files[0]) {
          selectedFile = input.files[0];
          document.getElementById("file-preview").classList.remove("hidden");
          document.getElementById("preview-name").innerText = selectedFile.name;
        }
      }

      function clearFile() {
        selectedFile = null;
        document.getElementById("file-input").value = "";
        document.getElementById("file-preview").classList.add("hidden");
      }

      async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById("msg-input");
        const content = input.value.trim();

        if (!content && !selectedFile) return;

        let msgData = {
          roomId: currentRoomId,
          username: myName,
          content,
          type: "text",
        };

        if (selectedFile) {
          const formData = new FormData();
          formData.append("file", selectedFile);
          try {
            const res = await fetch("/upload", {
              method: "POST",
              body: formData,
            });
            const data = await res.json();
            if (data.success) {
              msgData.type = data.fileType;
              msgData.content = data.fileUrl;
              msgData.fileName = data.fileName;
            }
          } catch (err) {
            alert("L·ªói upload file!");
            return;
          }
        }

        socket.emit("send_msg", msgData);
        input.value = "";
        clearFile();
      }

      socket.on("receive_msg", (msg) => renderMessage(msg));

      // Th√™m tin nh·∫Øn h·ªá th·ªëng (User v√†o/ra)
      socket.on("system_msg", (txt) => {
        const box = document.getElementById("msg-container");
        box.insertAdjacentHTML(
          "beforeend",
          `<div class="text-center text-xs text-gray-400 italic my-2">${txt}</div>`
        );
      });

      function renderMessage(msg) {
        const box = document.getElementById("msg-container");
        const isMe = msg.username === myName;

        let contentHtml = `<p>${msg.content}</p>`;
        if (msg.type === "image")
          contentHtml = `<img src="${msg.content}" class="max-w-[200px] rounded border cursor-pointer" onclick="window.open(this.src)">`;
        else if (msg.type === "file")
          contentHtml = `<a href="${msg.content}" target="_blank" class="text-blue-200 underline hover:text-white"><i class="fa-solid fa-download"></i> ${msg.fileName}</a>`;

        if (msg.type === "text" && !msg.content) return;

        const html = `
                <div class="flex flex-col ${
                  isMe ? "items-end" : "items-start"
                }">
                    <div class="max-w-[70%] ${
                      isMe ? "bg-indigo-600 text-white" : "bg-white border"
                    } p-3 rounded-lg shadow-sm">
                        ${
                          !isMe
                            ? `<div class="text-xs font-bold mb-1 opacity-70">${msg.username}</div>`
                            : ""
                        }
                        ${contentHtml}
                    </div>
                </div>`;
        box.insertAdjacentHTML("beforeend", html);
        box.scrollTop = box.scrollHeight;
      }
    </script>
  </body>
</html>
